name: Tests

on:
  pull_request:
    paths-ignore:
      - "README.md"
  push:
    branches:
      - master
    paths-ignore:
      - "README.md"

env:
  GO_VERSION: "1.26"
  BOOTC_VERSION: "1.13.0"

permissions:
  contents: read

jobs:
  build:
    name: Build (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    container:
      image: fedora:latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
            rust_target: x86_64-unknown-linux-gnu
          - arch: arm64
            runner: ubuntu-22.04-arm
            rust_target: aarch64-unknown-linux-gnu
    steps:
      - name: Install system dependencies
        run: |
          dnf install -y \
            git \
            gcc \
            pkgconf-pkg-config \
            ostree-devel \
            glib2-devel \
            openssl-devel \
            zlib-ng-compat-devel \
            libzstd-devel
      - uses: actions/checkout@v5
      - name: Configure git safe directory
        run: git config --global --add safe.directory "${GITHUB_WORKSPACE}"
      - uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          go-version-file: "go.mod"
          cache: true
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}
      - name: Set up sccache
        uses: mozilla-actions/sccache-action@v0.0.9
      - name: Cache bootc source
        id: cache-bootc-src
        uses: actions/cache@v4
        with:
          path: bootc-src
          key: bootc-src-${{ env.BOOTC_VERSION }}
      - name: Clone bootc source
        if: steps.cache-bootc-src.outputs.cache-hit != 'true'
        run: git clone --depth 1 --branch "v${{ env.BOOTC_VERSION }}" https://github.com/bootc-dev/bootc.git bootc-src
      - name: Build Rust bridge
        env:
          RUSTC_WRAPPER: sccache
          SCCACHE_GHA_ENABLED: "true"
        run: |
          rm -f target/.cargo-lock
          cargo build --release --target ${{ matrix.rust_target }} -p bootc-bridge
          rm -rf target/release
          ln -sfn ${{ matrix.rust_target }}/release target/release
      - run: go mod download
      - name: Build
        run: CGO_ENABLED=1 go build -v .

  test:
    name: Unit Tests (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    container:
      image: fedora:latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
            rust_target: x86_64-unknown-linux-gnu
          - arch: arm64
            runner: ubuntu-22.04-arm
            rust_target: aarch64-unknown-linux-gnu
    steps:
      - name: Install system dependencies
        run: |
          dnf install -y \
            git \
            gcc \
            pkgconf-pkg-config \
            ostree-devel \
            glib2-devel \
            openssl-devel \
            zlib-ng-compat-devel \
            libzstd-devel
      - uses: actions/checkout@v5
      - name: Configure git safe directory
        run: git config --global --add safe.directory "${GITHUB_WORKSPACE}"
      - uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          go-version-file: "go.mod"
          cache: true
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}
      - name: Set up sccache
        uses: mozilla-actions/sccache-action@v0.0.9
      - name: Cache bootc source
        id: cache-bootc-src
        uses: actions/cache@v4
        with:
          path: bootc-src
          key: bootc-src-${{ env.BOOTC_VERSION }}
      - name: Clone bootc source
        if: steps.cache-bootc-src.outputs.cache-hit != 'true'
        run: git clone --depth 1 --branch "v${{ env.BOOTC_VERSION }}" https://github.com/bootc-dev/bootc.git bootc-src
      - name: Build Rust bridge
        env:
          RUSTC_WRAPPER: sccache
          SCCACHE_GHA_ENABLED: "true"
        run: |
          rm -f target/.cargo-lock
          cargo build --release --target ${{ matrix.rust_target }} -p bootc-bridge
          rm -rf target/release
          ln -sfn ${{ matrix.rust_target }}/release target/release
      - run: go mod download
      - name: Run unit tests
        run: CGO_ENABLED=1 go test -v -cover -timeout=120s ./...

  acceptance-test:
    name: Acceptance Tests
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    timeout-minutes: 30
    steps:
      - name: Install system dependencies
        run: |
          dnf install -y \
            git \
            gcc \
            pkgconf-pkg-config \
            ostree-devel \
            glib2-devel \
            openssl-devel \
            zlib-ng-compat-devel \
            libzstd-devel \
            podman
      - uses: actions/checkout@v5
      - name: Configure git safe directory
        run: git config --global --add safe.directory "${GITHUB_WORKSPACE}"
      - uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          go-version-file: "go.mod"
          cache: true
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Set up sccache
        uses: mozilla-actions/sccache-action@v0.0.9
      - name: Cache bootc source
        id: cache-bootc-src
        uses: actions/cache@v4
        with:
          path: bootc-src
          key: bootc-src-${{ env.BOOTC_VERSION }}
      - name: Clone bootc source
        if: steps.cache-bootc-src.outputs.cache-hit != 'true'
        run: git clone --depth 1 --branch "v${{ env.BOOTC_VERSION }}" https://github.com/bootc-dev/bootc.git bootc-src
      - name: Build Rust bridge
        env:
          RUSTC_WRAPPER: sccache
          SCCACHE_GHA_ENABLED: "true"
        run: |
          rm -f target/.cargo-lock
          cargo build --release --target x86_64-unknown-linux-gnu -p bootc-bridge
          rm -rf target/release
          ln -sfn x86_64-unknown-linux-gnu/release target/release
      - run: go mod download
      - run: CGO_ENABLED=1 go test -v -cover -timeout=20m ./...
        env:
          TF_ACC: "1"
